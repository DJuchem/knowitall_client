<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>KnowItAll TV Spectator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; background: #000; color: #fff; overflow: hidden; }
        #bg { position: fixed; top:0; left:0; width: 100%; height: 100%; object-fit: cover; opacity: 0.6; z-index: -1; }
        #app { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        
        .hidden { display: none !important; }
        
        /* Lobby */
        .lobby-code { font-size: 8em; font-weight: 900; margin: 0; letter-spacing: 10px; text-shadow: 0 0 20px cyan; }
        .join-text { font-size: 2em; opacity: 0.8; }
        
        /* Quiz */
        .question-box { background: rgba(0,0,0,0.7); padding: 40px; border-radius: 20px; border: 2px solid rgba(255,255,255,0.2); max-width: 80%; }
        .question-text { font-size: 3em; font-weight: bold; margin-bottom: 30px; }
        .timer-bar { width: 100%; height: 10px; background: #333; margin-bottom: 20px; border-radius: 5px; overflow: hidden; }
        .timer-fill { height: 100%; background: lime; width: 100%; transition: width 1s linear; }
        
        /* Results */
        .leaderboard { display: flex; gap: 20px; align-items: flex-end; justify-content: center; height: 400px; }
        .bar { width: 100px; background: linear-gradient(to top, #444, #888); border-radius: 10px 10px 0 0; position: relative; transition: height 0.5s; }
        .bar.first { background: linear-gradient(to top, goldenrod, yellow); box-shadow: 0 0 30px gold; }
        .p-name { position: absolute; bottom: -30px; width: 100%; text-align: center; font-weight: bold; white-space: nowrap; }
        .p-score { position: absolute; top: -30px; width: 100%; text-align: center; font-size: 1.5em; font-weight: bold; }

    </style>
</head>
<body>
    <img id="bg" src="assets/bg/cyberpunk.jpg" alt="bg">
    
    <div id="app">
        <div id="setup-view">
            <h1>SPECTATOR MODE</h1>
            <input type="text" id="lobby-input" placeholder="LOBBY CODE" style="font-size:2em; padding:10px; text-transform:uppercase;">
            <button onclick="join()" style="font-size:2em; padding:10px;">WATCH</button>
        </div>

        <div id="lobby-view" class="hidden">
            <div class="join-text">JOIN AT KNOWITALL.COM</div>
            <div class="lobby-code" id="disp-code">CODE</div>
            <h2 id="player-count">0 PLAYERS READY</h2>
        </div>

        <div id="quiz-view" class="hidden">
            <div class="timer-bar"><div class="timer-fill" id="timer-fill"></div></div>
            <div class="question-box">
                <div class="question-text" id="q-text">Loading...</div>
                </div>
        </div>

        <div id="results-view" class="hidden">
            <h1 style="font-size: 4em; color: gold;">LEADERBOARD</h1>
            <div class="leaderboard" id="leaderboard"></div>
        </div>
    </div>

    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:5271/quizhub") // UPDATE PORT
            .withAutomaticReconnect()
            .build();

        let currentCode = "";

        async function join() {
            const code = document.getElementById('lobby-input').value.toUpperCase();
            if(!code) return;
            currentCode = code;
            
            try {
                await connection.start();
                // Join as spectator (isHost=false, name="TV", avatar="", spectator=true)
                await connection.invoke("JoinGame", code, "TV", "assets/avatars/tv.png", true); 
                
                document.getElementById('setup-view').classList.add('hidden');
                document.getElementById('lobby-view').classList.remove('hidden');
                document.getElementById('disp-code').innerText = code;
            } catch (err) {
                alert("Error: " + err);
            }
        }

        connection.on("lobby_update", (data) => {
            console.log("Update", data);
            document.getElementById('player-count').innerText = data.players.length + " PLAYERS JOINED";
            
            if (data.started) {
                document.getElementById('lobby-view').classList.add('hidden');
            } else {
                showView('lobby-view');
            }
        });

        connection.on("new_round", (data) => {
            showView('quiz-view');
            document.getElementById('q-text').innerText = data.questionData.Question;
            
            // Simple Timer Animation
            const fill = document.getElementById('timer-fill');
            fill.style.transition = 'none';
            fill.style.width = '100%';
            setTimeout(() => {
                fill.style.transition = `width ${data.timer}s linear`;
                fill.style.width = '0%';
            }, 50);
        });

        connection.on("question_results", (data) => {
            showView('results-view');
            renderLeaderboard(data.results);
        });

        connection.on("game_over", () => {
            showView('results-view'); // Stick to leaderboard
        });
        
        connection.on("game_reset", () => {
             showView('lobby-view');
        });

        function showView(id) {
            ['setup-view','lobby-view','quiz-view','results-view'].forEach(v => document.getElementById(v).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        function renderLeaderboard(results) {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            // Sort by score
            results.sort((a,b) => b.score - a.score);
            
            // Top 5
            results.slice(0, 5).forEach((p, i) => {
                const h = Math.max(50, (p.score / (results[0].score || 1)) * 300);
                const cls = i === 0 ? 'bar first' : 'bar';
                
                const div = document.createElement('div');
                div.className = cls;
                div.style.height = h + 'px';
                div.innerHTML = `
                    <div class="p-score">${p.score}</div>
                    <div class="p-name">${p.name}</div>
                `;
                board.appendChild(div);
            });
        }
    </script>
</body>
</html>