<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KNOW IT ALL - SPECTATOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    :root {
      --bg-dark: #0F1221;
      --primary: #47C8FF;
      --secondary: #FF58CC;
      --glass: rgba(20, 20, 35, 0.95);
      --glass-border: rgba(255, 255, 255, 0.15);
    }

    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      background-color: var(--bg-dark);
      background-image: url('assets/bg/cyberpunk.jpg');
      background-size: cover;
      background-position: center;
      color: white;
      font-family: 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    /* Dedicated overlay (always visible) */
    #bgOverlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 18, 33, 0.80);
      backdrop-filter: blur(6px);
      z-index: 0;
    }

    /* App root above overlay */
    #appRoot {
      position: relative;
      width: 100%;
      height: 100%;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    /* Logo top-left */
    #appLogo {
      position: absolute;
      top: 24px;
      left: 24px;
      width: 220px;
      z-index: 50;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.55));
      opacity: 0.95;
      pointer-events: none;
    }

    .glass-panel {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 32px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.8);
      padding: 40px;
      text-align: center;
    }

    #setup, #game, #lobbyView, #questionView, #resultsView, #gameOverView {
      width: 100%;
      height: 100%;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    #setup { display: flex; }

    /* Setup & QR */
    .setup-container { display:flex; align-items:center; gap:80px; margin-top: 60px; }
    .code-box { text-align:right; }
    .tv-code-label { font-size:20px; color:var(--primary); letter-spacing:4px; font-weight:bold; text-transform:uppercase; margin-bottom:5px; }
    .tv-code { font-size:120px; font-weight:900; color:white; text-shadow:0 0 40px var(--primary); letter-spacing:10px; line-height:1; }
    .tv-sub { font-size:18px; opacity:0.6; margin-top:10px; }
    .qr-box { background:white; padding:15px; border-radius:20px; box-shadow: 0 0 40px rgba(71,200,255,0.3); }
    .qr-box img { display:block; }

    /* Lobby */
    #lobbyView { flex-direction: row; padding: 100px 60px 40px 60px; box-sizing:border-box; align-items: stretch; gap: 40px; }
    .lobby-left { flex: 3; display:flex; flex-direction: column; padding-right: 10px; }
    .lobby-header {
      font-size: 36px;
      font-weight: 800;
      color: white;
      margin-bottom: 30px;
      letter-spacing: 2px;
      text-align: left;
      border-bottom: 2px solid rgba(255,255,255,0.1);
      padding-bottom: 20px;
      display:flex;
      align-items: baseline;
      gap: 12px;
    }
    .lobby-code { color: var(--primary); font-size: 48px; font-weight: 900; }

    .player-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
      width: 100%;
      align-content: start;
      overflow-y: auto;
      padding-right: 10px;
    }
    .player-card {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      display:flex;
      flex-direction: column;
      align-items:center;
    }
    .player-card.ready {
      border-color: var(--secondary);
      background: rgba(255, 88, 204, 0.15);
      box-shadow: 0 0 15px rgba(255, 88, 204, 0.3);
    }

    .avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid rgba(255,255,255,0.2);
      margin-bottom: 10px;
      background: #222;
    }

    .player-name {
      font-weight: bold;
      font-size: 16px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      max-width: 100%;
    }

    /* Chat */
    .chat-sidebar {
      flex: 1;
      min-width: 340px;
      background: rgba(0,0,0,0.30);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 20px;
      display:flex;
      flex-direction: column;
    }
    .chat-title {
      text-align:center;
      font-weight:bold;
      color: var(--primary);
      margin-bottom: 15px;
      letter-spacing: 1px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding-bottom: 10px;
    }
    #chatList { flex:1; overflow-y:auto; display:flex; flex-direction: column; gap: 10px; }
    .chat-msg { background: rgba(255,255,255,0.05); padding: 10px; border-radius: 12px; display:flex; gap: 10px; align-items:center; font-size:14px; }
    .chat-msg img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; }
    .chat-author { color: var(--primary); font-weight: bold; margin-right: 5px; }

    /* Question */
    #questionView { display:none; }
    .quiz-layout { display:flex; width: 100%; height: 100%; padding: 100px 40px 40px 40px; box-sizing:border-box; gap: 40px; }
    .main-q-area { flex:3; display:flex; flex-direction: column; align-items: center; justify-content:center; position: relative; }
    .side-standings { flex:1; background: rgba(0,0,0,0.30); border-radius: 24px; padding: 20px; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); min-width:250px; }
    .q-text { font-size: 36px; font-weight: 800; text-align:center; margin-bottom: 40px; text-shadow: 0 4px 10px rgba(0,0,0,0.5); }
    .media-frame { height: 250px; margin-bottom: 20px; display:none; }
    .media-frame img { height: 100%; border-radius: 12px; }
    .answers-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 90%; }
    .answer-box { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 20px; font-size: 24px; font-weight: 600; text-align:center; }
    .mini-rank { display:flex; align-items:center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size:14px; }
    .mini-rank img { width: 30px; height: 30px; border-radius: 50%; margin: 0 10px; object-fit: cover; }
    .mini-rank .score { margin-left:auto; font-weight: bold; color: var(--primary); }

    /* Results */
    #resultsView { display:none; }
    .correct-display { font-size: 48px; color: var(--secondary); font-weight: 900; margin-bottom: 30px; text-shadow: 0 0 20px rgba(255, 88, 204, 0.5); }
    .lb-row {
      display:flex; align-items:center; padding: 15px 30px; margin-bottom: 12px;
      background: rgba(255,255,255,0.08); border-radius: 16px;
      width: 80%; max-width: 1000px; margin: 0 auto 12px auto;
      justify-content: space-between;
    }
    .lb-row.winner {
      background: linear-gradient(90deg, rgba(71,200,255,0.2), rgba(255,88,204,0.2));
      border: 1px solid rgba(255,255,255,0.3);
      transform: scale(1.02);
    }
    .lb-row img { width: 50px; height: 50px; border-radius: 50%; margin: 0 20px; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }

    /* Game Over */
    #gameOverView { display:none; }
    .podium-container { display:flex; align-items:flex-end; justify-content:center; gap: 20px; height: 400px; margin-top: 40px; }
    .podium-column { display:flex; flex-direction: column; align-items:center; justify-content:flex-end; }
    .podium-block { width: 120px; background: rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; font-size: 40px; font-weight:bold; border-top-left-radius: 10px; border-top-right-radius: 10px; }
    .rank-1 .podium-block { height: 300px; background: linear-gradient(to top, rgba(255,215,0,0.5), transparent); border-top: 4px solid gold; }
    .rank-2 .podium-block { height: 200px; background: linear-gradient(to top, rgba(192,192,192,0.5), transparent); border-top: 4px solid silver; }
    .rank-3 .podium-block { height: 150px; background: linear-gradient(to top, rgba(205,127,50,0.5), transparent); border-top: 4px solid #cd7f32; }
    .podium-avatar { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 15px; border: 3px solid white; object-fit: cover; }

    audio { display:none; }

    /* Debug panel */
    #debugBox {
      position: fixed;
      left: 20px;
      bottom: 20px;
      width: 520px;
      max-width: 60vw;
      height: 260px;
      background: rgba(0,0,0,0.65);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      z-index: 99;
      display: none; /* OFF by default */
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(6px);
    }
    #debugHeader {
      padding: 8px 10px;
      font-size: 12px;
      color: rgba(255,255,255,0.85);
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }
    #debugLog {
      flex: 1;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      padding: 10px;
      overflow: auto;
      white-space: pre-wrap;
      color: rgba(255,255,255,0.92);
    }
    .dbgBtn {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.10);
      color: rgba(255,255,255,0.9);
      padding: 4px 10px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 12px;
    }
  </style>
</head>

<body>
  <div id="bgOverlay"></div>

  <div id="appRoot">
    <img id="appLogo" src="assets/logo2.png" onerror="this.style.display='none'">

    <div id="setup">
      <div class="glass-panel" style="padding: 50px 80px;">
        <div class="setup-container">
          <div class="code-box">
            <div class="tv-code-label">TV CODE</div>
            <div id="tvCode" class="tv-code">----</div>
            <div class="tv-sub">Enter on your device</div>
          </div>
          <div class="qr-box" style="margin-left: 40px;">
            <div id="qrcode-app"></div>
            <div style="color:black; font-weight:bold; margin-top:5px; font-size:12px;">OPEN APP</div>
          </div>
          <div class="qr-box" style="margin-left: 20px;">
            <div id="qrcode-tv"></div>
            <div style="color:black; font-weight:bold; margin-top:5px; font-size:12px;">SCAN CODE</div>
          </div>
        </div>
      </div>
    </div>

    <div id="game">
      <div id="lobbyView">
        <div class="lobby-left">
          <div class="lobby-header">
            <span>GAME LOBBY</span>
            <span style="opacity:0.55; font-size:24px;">CODE:</span>
            <span id="lobbyCodeDisplay" class="lobby-code">----</span>
          </div>
          <div id="playerGrid" class="player-grid"></div>
        </div>
        <div class="chat-sidebar">
          <div class="chat-title">CHAT</div>
          <div id="chatList"></div>
        </div>
      </div>

      <div id="questionView">
        <div class="quiz-layout">
          <div class="main-q-area">
            <div id="mediaContainer" class="media-frame"></div>

            <!-- YouTube player: NOT fully invisible (helps on some TVs/browsers) -->
            <div id="ytWrap" style="position:absolute; left:-9999px; top:-9999px; width:320px; height:180px;">
              <div id="ytPlayer"></div>
            </div>

            <div id="questionText" class="q-text">Loading...</div>
            <div id="answersContainer" class="answers-grid"></div>
          </div>

          <div class="side-standings">
            <h4 style="margin:0 0 15px 0; text-align:center; color:var(--primary);">RANKING</h4>
            <div id="miniStandingsList"></div>
          </div>
        </div>
      </div>

      <div id="resultsView">
        <div class="glass-panel" style="width: 80%; max-width: 1000px;">
          <div style="opacity:0.75; letter-spacing:2px; font-weight:700; margin-bottom:10px;">CORRECT ANSWER</div>
          <div id="correctAnswerDisplay" class="correct-display"></div>
          <div id="leaderboard"></div>
        </div>
      </div>

      <div id="gameOverView">
        <h1 style="font-size: 60px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 30px var(--primary);">GAME OVER</h1>
        <div id="podium" class="podium-container"></div>
      </div>
    </div>

    <audio id="bgMusic" loop></audio>

    <!-- DEBUG -->
    <div id="debugBox">
      <div id="debugHeader">
        <span id="dbgTitle">DEBUG</span>
        <span>
          <button class="dbgBtn" id="dbgCopy">Copy</button>
          <button class="dbgBtn" id="dbgClear">Clear</button>
          <button class="dbgBtn" id="dbgHide">Hide</button>
        </span>
      </div>
      <div id="debugLog"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
  <script>
    // -------------------------
    // Debug (OFF by default; enable via ?debug=1)
    // -------------------------
    const DEBUG_ENABLED = new URLSearchParams(window.location.search).get("debug") === "1";
    const dbgBox = document.getElementById("debugBox");
    const dbgLogEl = document.getElementById("debugLog");
    const debugLines = [];

    if (DEBUG_ENABLED) dbgBox.style.display = "flex";

    function ts() {
      const d = new Date();
      const hh = (d.getHours() % 12) || 12;
      const mm = String(d.getMinutes()).padStart(2,'0');
      const ss = String(d.getSeconds()).padStart(2,'0');
      const ap = d.getHours() >= 12 ? "PM" : "AM";
      return `[${hh}:${mm}:${ss} ${ap}]`;
    }

    function log(msg) {
      if (!DEBUG_ENABLED) return;
      const line = `${ts()} ${msg}`;
      debugLines.push(line);
      if (debugLines.length > 400) debugLines.shift();
      dbgLogEl.textContent = debugLines.join("\n");
      dbgLogEl.scrollTop = dbgLogEl.scrollHeight;
      console.log(line);
    }

    if (DEBUG_ENABLED) {
      document.getElementById("dbgCopy").onclick = async () => {
        try { await navigator.clipboard.writeText(debugLines.join("\n")); } catch {}
      };
      document.getElementById("dbgClear").onclick = () => { debugLines.length = 0; dbgLogEl.textContent = ""; };
      document.getElementById("dbgHide").onclick = () => { dbgBox.style.display = "none"; };
    }

    // -------------------------
    // Globals
    // -------------------------
    let globalPlayers = [];
    let ytPlayer = null;
    let ytReady = false;
    let pendingMusicPayload = null;
    let isMusicRound = false;

    const bgMusic = document.getElementById('bgMusic');

    // -------------------------
    // YouTube API
    // -------------------------
    function onYouTubeIframeAPIReady() {
      log("YouTube API ready");

      ytPlayer = new YT.Player('ytPlayer', {
        height: '180',
        width: '320',
        playerVars: {
          playsinline: 1,
          autoplay: 1,
          controls: 0,
          rel: 0,
          modestbranding: 1,
          iv_load_policy: 3
          // do NOT set mute:1
        },
        events: {
          onReady: () => {
            ytReady = true;
            log("YouTube player READY");
            if (pendingMusicPayload) {
              const mp = pendingMusicPayload;
              pendingMusicPayload = null;
              playMusicPayload(mp);
            }
          },
          onStateChange: (e) => {
            // -1 unstarted, 0 ended, 1 playing, 2 paused, 3 buffering, 5 cued
            log("YT state=" + (e && e.data));
          },
          onError: (e) => log("YouTube error: " + (e && e.data))
        }
      });
    }
    window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

    // -------------------------
    // QR / TV Code
    // -------------------------
    const tvCode = Math.random().toString(36).substring(2, 6).toUpperCase();
    document.getElementById('tvCode').innerText = tvCode;

    new QRCode(document.getElementById("qrcode-app"), {
      text: "https://know-it-all.fun",
      width: 140, height: 140,
      colorDark: "#000000", colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.L
    });

    new QRCode(document.getElementById("qrcode-tv"), {
      text: tvCode,
      width: 140, height: 140,
      colorDark: "#000000", colorLight: "#ffffff",
      correctLevel: QRCode.CorrectLevel.H
    });

    // -------------------------
    // Connection
    // -------------------------
    const isProduction = window.location.hostname.includes("know-it-all.fun");
    const serverUrl = isProduction
      ? `${window.location.protocol === "https:" ? "https:" : "http:"}//${window.location.host}/ws`
      : "http://localhost:5074/ws";

    log(`TV started. tvCode=${tvCode}`);
    log(`serverUrl=${serverUrl}`);

    const connection = new signalR.HubConnectionBuilder()
      .withUrl(serverUrl, { skipNegotiation: true, transport: signalR.HttpTransportType.WebSockets })
      .withAutomaticReconnect()
      .build();

    async function start() {
      try {
        log("connection.start()…");
        await connection.start();
        log("SignalR started. connectionId=" + (connection.connectionId ?? "null"));
        log(`Invoking RegisterTV(${tvCode})`);
        await connection.invoke("RegisterTV", tvCode);
        log("RegisterTV OK");
      } catch (err) {
        log("SignalR start/register failed: " + err);
        setTimeout(start, 3000);
      }
    }
    start();

    // -------------------------
    // View helpers
    // -------------------------
    function showOnly(viewId) {
      document.getElementById('setup').style.display = 'none';
      document.getElementById('game').style.display = 'flex';

      ['lobbyView','questionView','resultsView','gameOverView'].forEach(id => {
        document.getElementById(id).style.display = (id === viewId) ? 'flex' : 'none';
      });

      log(`VIEW -> ${viewId}`);

      // Leaving question view => stop YT
      if (viewId !== 'questionView') {
        try { if (ytPlayer && ytReady) ytPlayer.stopVideo(); } catch {}
        if (bgMusic && bgMusic.src && !isMusicRound) {
          bgMusic.play().catch(()=>{});
        }
      } else {
        if (bgMusic) bgMusic.pause();
      }
    }

    function showSetup() {
      document.getElementById('game').style.display = 'none';
      document.getElementById('setup').style.display = 'flex';
      log("VIEW -> setup");
    }

    // -------------------------
    // Asset helpers
    // -------------------------
    function fixAssetPath(path, fallback) {
      const fb = fallback || "assets/avatars/avatar_0.png";
      if (!path) return fb;
      if (path.startsWith("http") || path.startsWith("data:")) return path;

      let clean = path.replace(/^\//, "");
      if (!clean.startsWith("assets/")) clean = "assets/" + clean;
      clean = clean.replace(/^assets\/assets\//, "assets/");
      return clean;
    }

    function handleAvatarError(img) {
      img.onerror = null;
      img.src = "assets/avatars/avatar_0.png";
    }
    window.handleAvatarError = handleAvatarError;

    function normalizeName(n) {
      return String(n || "").trim().toLowerCase();
    }

    function avatarFor(playerName) {
      const key = normalizeName(playerName);
      if (!key) return "assets/avatars/avatar_0.png";

      const p = globalPlayers.find(x => normalizeName(x.name || x.Name) === key);
      const av = p ? (p.avatar || p.Avatar) : null;
      return fixAssetPath(av, "assets/avatars/avatar_0.png");
    }

    // -------------------------
    // Music playback (YouTube)
    // -------------------------
    function forceAudiblePulse() {
      if (!ytPlayer || !ytReady) return;
      try { ytPlayer.unMute(); } catch {}
      try { ytPlayer.setVolume(100); } catch {}
      try { ytPlayer.playVideo(); } catch {}
    }

    function playMusicPayload(mediaPayload) {
      if (!mediaPayload) return;

      if (!ytReady || !ytPlayer) {
        pendingMusicPayload = mediaPayload;
        log("YT not ready -> queued music payload");
        return;
      }

      let parts = String(mediaPayload).split('|');
      let videoId = parts[0];
      let startSec = 0;
      if (parts.length > 1) {
        let range = parts[1].split('-');
        startSec = parseInt(range[0]) || 0;
      }

      try {
        // hard stop/reset
        try { ytPlayer.stopVideo(); } catch {}

        // load & play
        ytPlayer.loadVideoById({ videoId, startSeconds: startSec });
        ytPlayer.playVideo();

        // pulse unmute/volume several times (helps on some TV browsers)
        forceAudiblePulse();
        setTimeout(forceAudiblePulse, 150);
        setTimeout(forceAudiblePulse, 500);
        setTimeout(forceAudiblePulse, 1200);
        setTimeout(forceAudiblePulse, 2500);

        log(`YT play requested: ${videoId} @ ${startSec}s`);
      } catch (e) {
        log("YT play failed: " + e);
      }
    }

    // -------------------------
    // Hub events
    // -------------------------
    connection.on("TVRegistered", () => log("EVENT: TVRegistered"));
    connection.on("tv_attached", (lobbyCode) => log("EVENT: tv_attached lobby=" + lobbyCode));
    connection.on("error", (msg) => log("EVENT: error " + msg));

    connection.on("ThemeUpdate", (data) => {
      const keys = data ? Object.keys(data) : [];
      log("EVENT: ThemeUpdate keys=" + keys.join(","));

      if (data && data.wallpaper) {
        const wp = fixAssetPath(data.wallpaper, "");
        document.body.style.backgroundImage = `url('${wp}')`;
      }

      // lobby bg music
      const enabled = data && data.musicEnabled === true;
      const vol = (data && typeof data.volume === "number") ? Math.max(0, Math.min(1, data.volume)) : 0.5;

      if (!enabled) {
        bgMusic.pause();
        bgMusic.removeAttribute("src");
        bgMusic.load();
        return;
      }

      if (!data || !data.music) return;

      const newSrc = fixAssetPath(data.music, "");
      if (!bgMusic.src || bgMusic.src.indexOf(newSrc) === -1) {
        bgMusic.src = newSrc;
      }
      bgMusic.volume = vol;

      // never play during question view or music rounds
      const questionVisible = document.getElementById('questionView').style.display === 'flex';
      if (questionVisible || isMusicRound) {
        bgMusic.pause();
        return;
      }

      bgMusic.play().catch(() => log("bgMusic blocked"));
    });

    connection.on("lobby_update", (state) => {
      log("EVENT: lobby_update");
      if (!state) return;

      if (state.started) return;

      showOnly('lobbyView');

      const validCode =
        state.lobbyCode || state.LobbyCode || state.code || state.Code || "ERR";
      document.getElementById('lobbyCodeDisplay').innerText = validCode;

      globalPlayers = state.players || state.Players || [];
      const grid = document.getElementById('playerGrid');
      grid.innerHTML = '';

      globalPlayers.forEach(p => {
        const name = p.name || p.Name || "Player";
        const av = fixAssetPath(p.avatar || p.Avatar, "assets/avatars/avatar_0.png");
        const isReady = (p.isReady === true) || (p.IsReady === true);
        const score = p.score ?? p.Score ?? 0;

        const card = document.createElement('div');
        card.className = `player-card ${isReady ? 'ready' : ''}`;
        card.innerHTML = `
          <img src="${av}" onerror="handleAvatarError(this)" class="avatar">
          <div class="player-name">${name}</div>
          <div style="font-size:12px; opacity:0.7;">${score} pts</div>
        `;
        grid.appendChild(card);
      });

      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';
      const chatData = state.chat || state.Chat || [];
      chatData.forEach(msg => {
        const from = msg.from || msg.From || msg.sender || msg.Sender || "Unknown";
        const text = msg.text || msg.Text || msg.message || msg.Message || "";
        const av = avatarFor(from);

        const div = document.createElement('div');
        div.className = 'chat-msg';
        div.innerHTML = `<img src="${av}" onerror="handleAvatarError(this)">
                         <div><span class="chat-author">${from}</span><span>${text}</span></div>`;
        chatList.appendChild(div);
      });
      chatList.scrollTop = chatList.scrollHeight;
    });

    function handleRound(data) {
      showOnly('questionView');

      // Stop lobby bg music for all questions (especially music)
      if (bgMusic) bgMusic.pause();

      // detect question payload
      let q = data?.questionData || data?.QuestionData || null;
      if (!q && data?.quizData && Array.isArray(data.quizData)) {
        const idx = data.questionIndex ?? 0;
        q = data.quizData[idx] || null;
      }
      if (!q) {
        log("Round: missing question payload");
        return;
      }

      // standings
      const players = data.players || data.Players || globalPlayers;
      if (players) globalPlayers = players;

      const miniList = document.getElementById('miniStandingsList');
      miniList.innerHTML = '';
      const sorted = [...globalPlayers].sort((a,b) => (b.score ?? b.Score ?? 0) - (a.score ?? a.Score ?? 0));
      sorted.slice(0, 10).forEach((p, i) => {
        const name = p.name || p.Name || "Player";
        const score = p.score ?? p.Score ?? 0;
        const av = fixAssetPath(p.avatar || p.Avatar, "assets/avatars/avatar_0.png");

        const row = document.createElement('div');
        row.className = 'mini-rank';
        row.innerHTML = `<span style="opacity:0.5; width:20px;">#${i+1}</span>
                         <img src="${av}" onerror="handleAvatarError(this)">
                         <span class="player-name" style="width:120px;">${name}</span>
                         <span class="score">${score}</span>`;
        miniList.appendChild(row);
      });

      document.getElementById('questionText').innerText =
        q.Question || q.question || "Question";

      const qType = String(q.Type || q.type || "").toLowerCase();
      const mediaPayload = q.MediaPayload || q.mediaPayload || "";
      const mediaBox = document.getElementById('mediaContainer');

      isMusicRound = qType.includes("music");

      if (isMusicRound && mediaPayload) {
        mediaBox.style.display = 'none';
        mediaBox.innerHTML = '';

        // Force YT playback every round
        playMusicPayload(mediaPayload);
      } else {
        try { if (ytPlayer && ytReady) ytPlayer.stopVideo(); } catch {}

        const mediaUrl = mediaPayload || q.Image || q.image || "";
        if (mediaUrl && String(mediaUrl).startsWith("http")) {
          mediaBox.style.display = 'block';
          mediaBox.innerHTML = `<img src="${mediaUrl}">`;
        } else {
          mediaBox.style.display = 'none';
          mediaBox.innerHTML = '';
        }
      }

      // answers (TV display only)
      const container = document.getElementById('answersContainer');
      container.innerHTML = '';

      let answers = [];
      const correct = q.CorrectAnswer || q.correctAnswer;
      const incorrect = q.IncorrectAnswers || q.incorrectAnswers || [];

      if (correct) answers.push(correct);
      if (Array.isArray(incorrect)) answers.push(...incorrect);

      for (let i = answers.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [answers[i], answers[j]] = [answers[j], answers[i]];
      }

      answers.forEach(ans => {
        const div = document.createElement('div');
        div.className = 'answer-box';
        div.innerText = ans;
        container.appendChild(div);
      });
    }

    connection.on("game_started", (data) => {
      log("EVENT: game_started");
      handleRound(data);
    });

    connection.on("new_round", (data) => {
      log("EVENT: new_round");
      handleRound(data);
    });

    connection.on("question_results", (data) => {
      log("EVENT: question_results");
      showOnly('resultsView');

      const correct = data.correctAnswer || data.CorrectAnswer || "";
      document.getElementById('correctAnswerDisplay').innerText = correct;

      const lb = document.getElementById('leaderboard');
      lb.innerHTML = '';

      const results = (data.results || data.Results || []).slice()
        .sort((a, b) => (b.score ?? 0) - (a.score ?? 0));

      // Resolve avatar by player name from last lobby_update
      results.slice(0, 8).forEach((p, index) => {
        const name = p.name || p.Name || "Player";
        const score = p.score ?? 0;
        const isCorrect = p.correct === true;
        const earned = p.earned ?? 0;

        const av = avatarFor(name);

        const row = document.createElement('div');
        row.className = `lb-row ${index === 0 ? 'winner' : ''}`;

        const statusIcon = isCorrect
          ? `<span style="color:#00ff00; font-size:24px; margin-right:15px;">✔ +${earned}</span>`
          : `<span style="color:#ff3333; font-size:24px; margin-right:15px;">✘</span>`;

        row.innerHTML = `
          <div style="display:flex; align-items:center;">
            <span style="opacity:0.5; width:30px; font-size:20px;">#${index + 1}</span>
            <img src="${av}" onerror="handleAvatarError(this)">
            <span style="font-size: 28px; font-weight:bold;">${name}</span>
          </div>
          <div style="display:flex; align-items:center;">
            ${statusIcon}
            <span style="font-weight:900; font-size:32px;">${score}</span>
          </div>
        `;
        lb.appendChild(row);
      });

      try { if (ytPlayer && ytReady) ytPlayer.stopVideo(); } catch {}
      isMusicRound = false;
    });

    connection.on("game_over", () => {
      log("EVENT: game_over");
      showOnly('gameOverView');

      const podium = document.getElementById('podium');
      podium.innerHTML = '';

      const winners = [...globalPlayers]
        .sort((a, b) => (b.score ?? b.Score ?? 0) - (a.score ?? a.Score ?? 0))
        .slice(0, 3);

      const order = [winners[1], winners[0], winners[2]].filter(Boolean);
      order.forEach(p => {
        const name = p.name || p.Name || "Player";
        const av = fixAssetPath(p.avatar || p.Avatar, "assets/avatars/avatar_0.png");
        const rank = winners.indexOf(p) + 1;

        const col = document.createElement('div');
        col.className = `podium-column rank-${rank}`;
        col.innerHTML = `
          <div style="font-weight:bold; font-size:20px; margin-bottom:5px;">${name}</div>
          <img src="${av}" onerror="handleAvatarError(this)" class="podium-avatar">
          <div class="podium-block">${rank}</div>
        `;
        podium.appendChild(col);
      });
    });

    connection.on("lobby_deleted", () => {
      log("EVENT: lobby_deleted");
      isMusicRound = false;
      pendingMusicPayload = null;
      try { if (ytPlayer && ytReady) ytPlayer.stopVideo(); } catch {}
      if (bgMusic) bgMusic.pause();
      showSetup();
    });

    // Default
    showSetup();
  </script>
</body>
</html>
