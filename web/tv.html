<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>KNOW IT ALL - SPECTATOR</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://www.youtube.com/iframe_api"></script>

  <style>
    /* --- CORE THEME --- */
    :root {
      --bg-dark: #0F1221;
      --primary: #47C8FF;
      --secondary: #FF58CC;
      --glass: rgba(20, 20, 35, 0.85);
      --glass-border: rgba(255, 255, 255, 0.15);
    }

    html, body {
      margin: 0; padding: 0; width: 100vw; height: 100vh;
      background-color: var(--bg-dark);
      background-image: url('assets/bg/background_default.webp');
      background-size: cover;
      background-position: center;
      color: white;
      font-family: 'Segoe UI', system-ui, sans-serif;
      overflow: hidden;
    }

    #bgOverlay{
      position: fixed; inset: 0; z-index: 0;
      background-image: linear-gradient(rgba(15,18,33,0.85), rgba(15,18,33,0.85)),
                        url('assets/bg/cyberpunk.jpg');
      background-size: cover; background-position: center; background-repeat: no-repeat;
    }

    #appRoot {
      position: relative; width: 100%; height: 100%; z-index: 1;
      display: flex; flex-direction: column; align-items: center; justify-content: center;
    }

    /* --- COOL EFFECTS: EDGE LIGHTING --- */
    @property --angle {
      syntax: '<angle>'; initial-value: 0deg; inherits: false;
    }

    @keyframes rotateBorder {
      0% { --angle: 0deg; }
      100% { --angle: 360deg; }
    }

    /* Standard Edge Light (Large Panels) */
    .edge-light {
      position: relative;
      border: 3px solid transparent; 
      border-radius: 32px;
      background: 
        linear-gradient(var(--glass), var(--glass)) padding-box, 
        conic-gradient(from var(--angle), var(--primary), var(--secondary), var(--primary)) border-box;
      animation: rotateBorder 4s linear infinite;
      box-shadow: 0 0 40px rgba(71, 200, 255, 0.15);
    }

    /* Smaller Edge Light (for Answer Boxes / Cards) */
    .edge-light-small {
      position: relative;
      border: 2px solid transparent; 
      border-radius: 16px;
      background: 
        linear-gradient(rgba(255,255,255,0.05), rgba(255,255,255,0.05)) padding-box, 
        conic-gradient(from var(--angle), var(--primary), var(--secondary), var(--primary)) border-box;
      animation: rotateBorder 3s linear infinite reverse; /* Reverse spin for contrast */
      box-shadow: 0 0 15px rgba(255, 88, 204, 0.2);
    }

    /* --- ANIMATIONS --- */
    @keyframes float {
      0% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
      100% { transform: translateY(0px); }
    }

    @keyframes popIn {
      0% { transform: scale(0.8); opacity: 0; }
      100% { transform: scale(1); opacity: 1; }
    }

    @keyframes msgSlide {
      from { opacity: 0; transform: translateX(30px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* --- UI ELEMENTS --- */
    #appLogo {
      position: absolute; top: 20px; left: 20px; width: 140px; z-index: 50;
      filter: drop-shadow(0 0 10px rgba(0,0,0,0.55)); opacity: 0.95; pointer-events: none;
    }

    .glass-panel {
      background: var(--glass); border: 1px solid var(--glass-border);
      border-radius: 32px; box-shadow: 0 30px 60px rgba(0,0,0,0.8);
      padding: 40px; text-align: center; backdrop-filter: blur(12px);
    }

    #setup, #game, #lobbyView, #questionView, #resultsView, #gameOverView {
      width: 100%; height: 100%; display: none;
      flex-direction: column; align-items: center; justify-content: center;
    }
    #setup { display: flex; }

    /* SETUP */
    .setup-container { display:flex; align-items:center; gap:80px; margin-top: 60px; }
    .code-box { text-align:right; }
    .tv-code-label { font-size:20px; color:var(--primary); letter-spacing:4px; font-weight:bold; text-transform:uppercase; margin-bottom:5px; }
    .tv-code { font-size:120px; font-weight:900; color:white; text-shadow:0 0 40px var(--primary); letter-spacing:10px; line-height:1; }
    .tv-sub { font-size:18px; opacity:0.6; margin-top:10px; }
    .qr-box { background:white; padding:15px; border-radius:20px; box-shadow: 0 0 40px rgba(71,200,255,0.3); }
    .qr-box img { display:block; }

    /* LOBBY */
    #lobbyView { flex-direction: row; padding: 100px 60px 40px 60px; box-sizing:border-box; align-items: stretch; gap: 40px; }
    .lobby-left { flex: 3; display:flex; flex-direction: column; padding-right: 10px; }
    .lobby-header {
      font-size: 36px; font-weight: 800; color: white; margin-bottom: 30px;
      letter-spacing: 2px; text-align: left; border-bottom: 2px solid rgba(255,255,255,0.1);
      padding-bottom: 20px; display:flex; align-items: baseline; gap: 12px;
    }
    .lobby-code { color: var(--primary); font-size: 48px; font-weight: 900; text-shadow: 0 0 15px var(--primary); }

    .player-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px; width: 100%; align-content: start; overflow-y: auto; padding-right: 10px;
    }
    .player-card {
      /* Base style, JS adds edge-light-small on ready */
      background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
      border-radius: 20px; padding: 20px; display:flex; flex-direction: column; align-items:center;
      transition: transform 0.3s;
    }
    .player-card.ready {
      /* The edge light class handles the border now */
      animation: float 4s ease-in-out infinite, rotateBorder 3s linear infinite reverse; 
    }

    .avatar {
      width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
      border: 3px solid rgba(255,255,255,0.2); margin-bottom: 10px; background: #222;
    }
    .player-name { font-weight: bold; font-size: 16px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 100%; }

    /* CHAT */
    .chat-sidebar {
      flex: 1; min-width: 340px; 
      /* Edge lighting applied via class in HTML */
      padding: 20px; display:flex; flex-direction: column;
    }
    .chat-title {
      text-align:center; font-weight:bold; color: var(--primary); margin-bottom: 15px;
      letter-spacing: 1px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;
    }
    #chatList { flex:1; overflow-y:auto; display:flex; flex-direction: column; gap: 12px; }

    .chat-msg { 
      background: linear-gradient(90deg, rgba(255,255,255,0.1), rgba(255,255,255,0.02));
      padding: 14px; border-radius: 12px; display:flex; gap: 12px; align-items:center; 
      font-size: 20px; border-left: 4px solid var(--primary);
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      animation: msgSlide 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
    }
    .chat-msg img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border:1px solid rgba(255,255,255,0.3); }
    .chat-author { color: var(--primary); font-weight: 900; margin-right: 8px; letter-spacing: 0.5px; }

    /* QUESTION */
    #questionView { display:none; }
    .quiz-layout { display:flex; width: 100%; height: 100%; padding: 100px 40px 40px 40px; box-sizing:border-box; gap: 40px; }
    .main-q-area { flex:3; display:flex; flex-direction: column; align-items: center; justify-content:center; position: relative; }
    .side-standings { flex:1; background: rgba(0,0,0,0.30); border-radius: 24px; padding: 20px; overflow-y:auto; border:1px solid rgba(255,255,255,0.1); min-width:250px; }
    
    .q-text { 
      font-size: 42px; font-weight: 900; text-align:center; margin-bottom: 40px; 
      text-shadow: 0 0 20px rgba(255,255,255,0.4); line-height: 1.2;
    }
    
    .media-frame { height: 250px; margin-bottom: 20px; display:none; }
    .media-frame img { height: 100%; border-radius: 12px; box-shadow: 0 0 20px black; }
    
    .answers-grid { display:grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 90%; }
    
    /* ANSWER BOX - Edge Lighting handled in JS or CSS class below */
    .answer-box { 
      /* Base style */
      padding: 25px; font-size: 28px; font-weight: 700; text-align:center;
      transition: transform 0.2s;
      cursor: pointer;
    }
    .answer-box:hover { transform: scale(1.02); }

    .mini-rank { display:flex; align-items:center; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-size:14px; }
    .mini-rank img { width: 30px; height: 30px; border-radius: 50%; margin: 0 10px; object-fit: cover; }
    .mini-rank .score { margin-left:auto; font-weight: bold; color: var(--primary); }

    /* RESULTS */
    #resultsView { display:none; }
    .correct-display { 
      font-size: 56px; color: var(--secondary); font-weight: 900; margin-bottom: 30px; 
      text-shadow: 0 0 30px rgba(255, 88, 204, 0.6); animation: float 3s ease-in-out infinite;
    }
    .lb-row {
      display:flex; align-items:center; padding: 15px 30px; margin-bottom: 12px;
      background: rgba(255,255,255,0.08); border-radius: 16px;
      width: 80%; max-width: 1000px; margin: 0 auto 12px auto;
      justify-content: space-between;
    }
    .lb-row.winner {
      background: linear-gradient(90deg, rgba(71,200,255,0.2), rgba(255,88,204,0.2));
      border: 1px solid rgba(255,255,255,0.3); transform: scale(1.05);
      box-shadow: 0 0 20px rgba(255,88,204,0.3);
    }
    .lb-row img { width: 50px; height: 50px; border-radius: 50%; margin: 0 20px; object-fit: cover; border: 2px solid rgba(255,255,255,0.2); }

    /* GAME OVER */
    #gameOverView { display:none; }
    .podium-container { display:flex; align-items:flex-end; justify-content:center; gap: 20px; height: 450px; margin-top: 40px; }
    .podium-column { display:flex; flex-direction: column; align-items:center; justify-content:flex-end; }
    .podium-block { width: 140px; background: rgba(255,255,255,0.1); display:flex; align-items:center; justify-content:center; font-size: 40px; font-weight:bold; border-top-left-radius: 15px; border-top-right-radius: 15px; }
    
    .rank-1 .podium-block { 
      height: 320px; background: linear-gradient(to top, rgba(255,215,0,0.6), rgba(255,215,0,0.1)); 
      border-top: 4px solid gold; box-shadow: 0 0 40px rgba(255,215,0,0.3);
    }
    .rank-2 .podium-block { height: 220px; background: linear-gradient(to top, rgba(192,192,192,0.6), rgba(192,192,192,0.1)); border-top: 4px solid silver; }
    .rank-3 .podium-block { height: 160px; background: linear-gradient(to top, rgba(205,127,50,0.6), rgba(205,127,50,0.1)); border-top: 4px solid #cd7f32; }
    
    .podium-avatar { 
      width: 120px; height: 120px; border-radius: 50%; margin-bottom: 15px; 
      border: 4px solid white; object-fit: cover; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
    }
    .rank-1 .podium-avatar { width: 150px; height: 150px; border-color: gold; animation: float 3s infinite ease-in-out; }

    /* Hide elements */
    audio { display:none; }
    #ytWrap { position:fixed; bottom:0; right:0; width:320px; height:180px; opacity:0; pointer-events:none; z-index:-1; }
    #debugBox { display:none; }
  </style>
</head>

<body>
  <div id="bgOverlay"></div>

  <div id="appRoot">
    <img id="appLogo" src="assets/logo2.png" onerror="this.style.display='none'">

    <div id="setup">
      <div class="glass-panel edge-light" style="padding: 50px 80px;">
        <div class="setup-container">
          <div class="code-box">
            <div class="tv-code-label">TV CODE</div>
            <div id="tvCode" class="tv-code">----</div>
            <div class="tv-sub">Enter on your device</div>
          </div>
          <div class="qr-box" style="margin-left: 40px;">
            <div id="qrcode-app"></div>
            <div style="color:black; font-weight:bold; margin-top:5px; font-size:12px;">OPEN APP</div>
          </div>
          <div class="qr-box" style="margin-left: 20px;">
            <div id="qrcode-tv"></div>
            <div style="color:black; font-weight:bold; margin-top:5px; font-size:12px;">SCAN CODE</div>
          </div>
        </div>
      </div>
    </div>

    <div id="game">
      <div id="lobbyView">
        <div class="lobby-left">
          <div class="lobby-header">
            <span>GAME LOBBY</span>
            <span style="opacity:0.55; font-size:24px;">CODE:</span>
            <span id="lobbyCodeDisplay" class="lobby-code edge-light" style="padding: 5px 20px; border-radius: 12px; margin-left: 10px;">----</span>
          </div>
          <div id="playerGrid" class="player-grid"></div>
        </div>
        
        <div class="chat-sidebar edge-light">
          <div class="chat-title">CHAT</div>
          <div id="chatList"></div>
        </div>
      </div>

      <div id="questionView">
        <div class="quiz-layout">
          <div class="main-q-area">
            <div id="mediaContainer" class="media-frame"></div>
            <div id="ytWrap" style="position:fixed; bottom:0; right:0; width:320px; height:180px; opacity:0; pointer-events:none; z-index:-1;">
              <div id="ytPlayer"></div>
            </div>
            <div id="questionText" class="q-text">Loading...</div>
            <div id="answersContainer" class="answers-grid"></div>
          </div>
          <div class="side-standings">
            <h4 style="margin:0 0 15px 0; text-align:center; color:var(--primary);">RANKING</h4>
            <div id="miniStandingsList"></div>
          </div>
        </div>
      </div>

      <div id="resultsView">
        <div class="glass-panel edge-light" style="width: 80%; max-width: 1000px;">
          <div style="opacity:0.75; letter-spacing:2px; font-weight:700; margin-bottom:10px;">CORRECT ANSWER</div>
          <div id="correctAnswerDisplay" class="correct-display"></div>
          <div id="leaderboard"></div>
        </div>
      </div>

      <div id="gameOverView">
        <h1 style="font-size: 60px; font-weight: 900; margin-bottom: 20px; text-shadow: 0 0 30px var(--primary);">GAME OVER</h1>
        <div id="podium" class="podium-container"></div>
      </div>
    </div>

    <audio id="bgMusic" loop></audio>

    <div id="debugBox">
      <div id="debugHeader">
        <span id="dbgTitle">DEBUG</span>
        <span>
          <button class="dbgBtn" id="dbgCopy">Copy</button>
          <button class="dbgBtn" id="dbgClear">Clear</button>
          <button class="dbgBtn" id="dbgHide">Hide</button>
        </span>
      </div>
      <div id="debugLog"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
  <script>
  // -------------------------
  // Debug & Globals
  // -------------------------
  const DEBUG_ENABLED = new URLSearchParams(window.location.search).get("debug") === "1";
  function log(msg) { if(DEBUG_ENABLED) console.log(`[TV] ${msg}`); }

  let globalPlayers = [];
  let ytPlayer = null;
  let ytReady = false;
  let pendingMusicPayload = null;
  
  // State Flags
  let isMusicRound = false; 
  let isGameInMusicMode = false; 
  
  // ✅ FIX: Track the warm-up timer so we can kill it
  let warmupTimeout = null;

  const bgMusic = document.getElementById('bgMusic');
  const bgOverlay = document.getElementById('bgOverlay');

  function $(id) { return document.getElementById(id); }
  function safeSetText(id, text) { const el = $(id); if (el) el.innerText = text ?? ""; }
  function safeShow(id, display) { const el = $(id); if (el) el.style.display = display; }

  // -------------------------
  // YouTube API
  // -------------------------
  function onYouTubeIframeAPIReady() {
    ytPlayer = new YT.Player('ytPlayer', {
      height: '180', width: '320',
      playerVars: {
        playsinline: 1, autoplay: 1, controls: 0,
        disablekb: 1, fs: 0, rel: 0, modestbranding: 1,
        iv_load_policy: 3
      },
      events: {
        onReady: (event) => {
          ytReady = true;
          event.target.setVolume(100);
          
          if (!pendingMusicPayload) {
             // Silent Warm-up to wake TV Audio
             event.target.mute();
             event.target.playVideo();
             
             // ✅ SAVE TIMEOUT ID so we can cancel it if a song arrives
             warmupTimeout = setTimeout(() => {
                 event.target.pauseVideo();
                 event.target.unMute();
             }, 500);
          } else {
             playMusicPayload(pendingMusicPayload);
          }
        },
        onStateChange: (event) => {
          // Force play only if round active
          if ((event.data === 2 || event.data === 5) && isMusicRound) {
             event.target.playVideo();
          }
        },
        onError: (e) => {
             // Retry once on error, but only if round is active
             if ((e.data === 150 || e.data === 101) && isMusicRound) {
                setTimeout(() => { 
                    if(ytPlayer && ytPlayer.playVideo && isMusicRound) ytPlayer.playVideo(); 
                }, 1000);
             }
        }
      }
    });
  }
  window.onYouTubeIframeAPIReady = onYouTubeIframeAPIReady;

  function playMusicPayload(mediaPayload) {
    if (!mediaPayload) return;
    
    // ✅ CRITICAL FIX: Cancel any pending warm-up pause!
    if (warmupTimeout) {
        clearTimeout(warmupTimeout);
        warmupTimeout = null;
    }

    pendingMusicPayload = mediaPayload; 

    if (!ytReady || !ytPlayer || typeof ytPlayer.loadVideoById !== 'function') {
      return; 
    }

    // 1. Parse "VIDEO_ID|START-END"
    const parts = String(mediaPayload).split('|');
    const videoId = parts[0].trim();
    
    // ✅ DEFAULTS: 40s - 100s
    let startSec = 40;
    let endSec = 100;

    if (parts.length > 1) {
      const range = parts[1].split('-');
      const s = parseInt(range[0], 10);
      const e = parseInt(range[1], 10);
      if (!isNaN(s)) startSec = s;
      if (!isNaN(e)) endSec = e;
    }

    try {
      const loadParams = {
        videoId: videoId,
        startSeconds: startSec,
        endSeconds: endSec
      };

      ytPlayer.loadVideoById(loadParams);
      ytPlayer.setVolume(100);
      ytPlayer.unMute();
      
      // Strict safety retry inside timeout
      setTimeout(() => {
        if (isMusicRound && ytPlayer && ytPlayer.getPlayerState) {
           const s = ytPlayer.getPlayerState();
           if (s === -1 || s === 2) ytPlayer.playVideo();
        }
      }, 1500);

    } catch (e) { log("YT Exception: " + e); }
  }

  function stopYoutube() {
    try {
      if (ytPlayer && ytReady && typeof ytPlayer.stopVideo === 'function') {
        ytPlayer.stopVideo();
        if (typeof ytPlayer.clearVideo === 'function') ytPlayer.clearVideo();
      }
    } catch (e) {}
  }

  // -------------------------
  // Wallpaper & Music Helpers
  // -------------------------
  function applyWallpaper(url) {
    if (!url) return;
    document.body.style.backgroundImage = `url('${url}')`;
    if (bgOverlay) {
      bgOverlay.style.backgroundImage = `linear-gradient(rgba(15,18,33,0.80), rgba(15,18,33,0.80)), url('${url}')`;
      bgOverlay.style.backgroundSize = 'cover';
      bgOverlay.style.backgroundPosition = 'center';
      bgOverlay.style.backgroundRepeat = 'no-repeat';
    }
  }
  applyWallpaper('assets/bg/cyberpunk.jpg');

  function manageBackgroundMusic(shouldPlay) {
    if (!bgMusic || !bgMusic.src) return;

    // Strict: If Game is in Music Mode, BG Music NEVER plays.
    if (isGameInMusicMode) {
        bgMusic.pause();
        return;
    }

    if (shouldPlay) {
        bgMusic.play().catch(() => {});
    } else {
        bgMusic.pause();
    }
  }

  // -------------------------
  // SignalR & Game Logic
  // -------------------------
  function scoreOf(p) {
    if (!p) return 0;
    const raw = p.score ?? p.Score ?? p.totalScore ?? p.TotalScore ?? 0;
    return Number(raw) || 0;
  }
  function normalizeName(n) { return String(n || "").trim().toLowerCase(); }
  
  function fixAssetPath(path, fallback) {
    const fb = fallback || "assets/avatars/avatar_0.png";
    if (!path) return fb;
    if (path.startsWith("http") || path.startsWith("data:")) return path;
    let clean = path.replace(/^\//, "");
    if (!clean.startsWith("assets/")) clean = "assets/" + clean;
    return clean.replace(/^assets\/assets\//, "assets/");
  }
  window.handleAvatarError = function(img) { img.onerror = null; img.src = "assets/avatars/avatar_0.png"; };

  function avatarFor(playerName) {
    const key = normalizeName(playerName);
    const p = globalPlayers.find(x => normalizeName(x.name || x.Name) === key);
    return fixAssetPath(p ? (p.avatar || p.Avatar) : null, "assets/avatars/avatar_0.png");
  }

  // QR & Setup
  function genNumericCode(len) {
    let out = "";
    for (let i = 0; i < len; i++) out += String(Math.floor(Math.random() * 10));
    return out;
  }
  const tvCode = genNumericCode(4);
  safeSetText('tvCode', tvCode);

  if ($('qrcode-app')) new QRCode($('qrcode-app'), { text: "https://know-it-all.fun", width: 140, height: 140, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.L });
  if ($('qrcode-tv')) new QRCode($('qrcode-tv'), { text: tvCode, width: 140, height: 140, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });

  // Connection
  const isProduction = window.location.hostname.includes("know-it-all.fun");
  const serverUrl = isProduction ? `${window.location.protocol}//${window.location.host}/ws` : "http://localhost:5074/ws";

  const connection = new signalR.HubConnectionBuilder()
    .withUrl(serverUrl, { skipNegotiation: true, transport: signalR.HttpTransportType.WebSockets })
    .withAutomaticReconnect()
    .build();

  async function start() {
    try {
      await connection.start();
      await connection.invoke("RegisterTV", tvCode);
    } catch (err) { setTimeout(start, 3000); }
  }
  start();

  // -------------------------
  // View Controller
  // -------------------------
  function showOnly(viewId) {
    safeShow('setup', 'none');
    safeShow('game', 'flex');
    ['lobbyView','questionView','resultsView','gameOverView'].forEach(id => {
      safeShow(id, (id === viewId) ? 'flex' : 'none');
    });

    if (viewId !== 'questionView') {
       // Leaving a question -> Stop YT and resume BG
       stopYoutube();
       manageBackgroundMusic(true); 
    }
  }

  function showSetup() {
    safeShow('game', 'none');
    safeShow('setup', 'flex');
    isGameInMusicMode = false; // Reset
    manageBackgroundMusic(true);
  }

  // -------------------------
  // Hub Events
  // -------------------------
  connection.on("ThemeUpdate", (data) => {
    if (data && data.wallpaper) applyWallpaper(fixAssetPath(data.wallpaper, ""));
    
    if (bgMusic) {
        if (data.musicEnabled === false) {
            bgMusic.pause();
        } else if (data.music) {
            const src = fixAssetPath(data.music, "");
            if (!bgMusic.src.includes(src)) bgMusic.src = src;
            bgMusic.volume = (typeof data.volume === "number") ? data.volume : 0.5;
            
            // Try play (internally checks music mode)
            if (!isMusicRound) manageBackgroundMusic(true);
        }
    }
  });

  connection.on("lobby_update", (state) => {
    if (!state || state.started) return;
    showOnly('lobbyView');
    
    // Check Music Mode
    const mode = state.mode || state.Mode || "";
    isGameInMusicMode = mode.toLowerCase().includes("music");
    
    // Force Stop BG if music mode
    if (isGameInMusicMode) manageBackgroundMusic(false);
    else manageBackgroundMusic(true);

    safeSetText('lobbyCodeDisplay', state.lobbyCode || state.code || "ERR");
    globalPlayers = state.players || [];

    const grid = $('playerGrid');
    if (grid) {
      grid.innerHTML = '';
      globalPlayers.forEach(p => {
        const name = p.name || p.Name || "Player";
        const av = fixAssetPath(p.avatar || p.Avatar, "assets/avatars/avatar_0.png");
        const isReady = p.isReady === true || p.IsReady === true;
        const card = document.createElement('div');
        // Add edge-light-small class if ready
        card.className = `player-card ${isReady ? 'ready edge-light-small' : ''}`;
        card.innerHTML = `<img src="${av}" onerror="handleAvatarError(this)" class="avatar">
                          <div class="player-name">${name}</div>
                          <div style="font-size:12px; opacity:0.7;">${scoreOf(p)} pts</div>`;
        grid.appendChild(card);
      });
    }

    const chatList = $('chatList');
    if (chatList) {
      chatList.innerHTML = '';
      (state.chat || []).forEach(msg => {
        const from = msg.from || msg.sender || "Unknown";
        const text = msg.text || msg.message || "";
        const av = avatarFor(from);
        const div = document.createElement('div');
        div.className = 'chat-msg';
        div.innerHTML = `<img src="${av}" onerror="handleAvatarError(this)">
                         <div><span class="chat-author">${from}</span><span>${text}</span></div>`;
        chatList.appendChild(div);
      });
      chatList.scrollTop = chatList.scrollHeight;
    }
  });

  function handleRound(data) {
    showOnly('questionView');
    
    let q = data?.questionData;
    if (!q && data?.quizData) q = data.quizData[data.questionIndex || 0];
    if (!q) return;

    if (data.players) globalPlayers = data.players;

    const miniList = $('miniStandingsList');
    if (miniList) {
      miniList.innerHTML = '';
      [...globalPlayers].sort((a,b) => scoreOf(b)-scoreOf(a)).slice(0,10).forEach((p,i) => {
         const name = p.name || p.Name || "Player";
         const av = fixAssetPath(p.avatar || p.Avatar, "assets/avatars/avatar_0.png");
         const row = document.createElement('div');
         row.className = 'mini-rank';
         row.innerHTML = `<span style="opacity:0.5; width:20px;">#${i+1}</span>
                          <img src="${av}" onerror="handleAvatarError(this)">
                          <span class="player-name" style="width:120px;">${name}</span>
                          <span class="score">${scoreOf(p)}</span>`;
         miniList.appendChild(row);
      });
    }

    safeSetText('questionText', q.Question || q.question || "Question");

    const qType = String(q.Type || q.type || "").toLowerCase();
    const mediaPayload = q.MediaPayload || q.mediaPayload || "";
    isMusicRound = qType.includes("music");
    
    // Ensure Music Mode flag is set if we are in a music round
    if (isMusicRound) isGameInMusicMode = true; 

    const mediaBox = $('mediaContainer');

    if (isMusicRound && mediaPayload) {
       manageBackgroundMusic(false); // STOP BG
       if (mediaBox) mediaBox.style.display = 'none';
       playMusicPayload(mediaPayload);
    } else {
       stopYoutube();
       // PLAY BG (but manageBackgroundMusic will block if isGameInMusicMode is true)
       manageBackgroundMusic(true); 
       
       const imgUrl = mediaPayload || q.Image || q.image;
       if (mediaBox) {
         if (imgUrl && String(imgUrl).startsWith("http")) {
            mediaBox.style.display = 'block';
            mediaBox.innerHTML = `<img src="${imgUrl}">`;
         } else {
            mediaBox.style.display = 'none';
         }
       }
    }

    const container = $('answersContainer');
    if (container) {
      container.innerHTML = '';
      let answers = [];
      const c = q.CorrectAnswer || q.correctAnswer;
      const inc = q.IncorrectAnswers || q.incorrectAnswers || [];
      if (c) answers.push(c);
      if (Array.isArray(inc)) answers.push(...inc);
      for (let i = answers.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [answers[i], answers[j]] = [answers[j], answers[i]];
      }
      answers.forEach(ans => {
        const div = document.createElement('div');
        // Add edge-light-small to answers for effect
        div.className = 'answer-box edge-light-small';
        div.innerText = ans;
        container.appendChild(div);
      });
    }
  }

  connection.on("game_started", (d) => handleRound(d));
  connection.on("new_round", (d) => handleRound(d));

  connection.on("question_results", (data) => {
    // 1. Mark round as over immediately to stop YT auto-resume
    isMusicRound = false; 
    pendingMusicPayload = null;

    // 2. Stop YouTube
    stopYoutube();

    // 3. Show View
    showOnly('resultsView');

    // 4. RESUME BG MUSIC (User wanted this everywhere between rounds)
    manageBackgroundMusic(true);

    safeSetText('correctAnswerDisplay', data.correctAnswer || data.CorrectAnswer || "");

    const results = (data.results || []).slice().sort((a,b) => scoreOf(b)-scoreOf(a));
    results.forEach(r => {
       const pName = normalizeName(r.name || r.Name);
       const gp = globalPlayers.find(x => normalizeName(x.name||x.Name) === pName);
       if (gp) {
         const s = r.score ?? r.Score ?? gp.score;
         gp.score = s; gp.Score = s; gp.totalScore = s;
       }
    });

    const lb = $('leaderboard');
    if (lb) {
      lb.innerHTML = '';
      results.slice(0,8).forEach((p, i) => {
        const name = p.name || p.Name;
        const correct = p.correct === true || p.Correct === true;
        const earned = p.earned || p.Earned || 0;
        const av = avatarFor(name);
        
        const row = document.createElement('div');
        row.className = `lb-row ${i===0?'winner':''}`;
        const icon = correct 
          ? `<span style="color:#00ff00; font-size:24px; margin-right:15px;">✔ +${earned}</span>`
          : `<span style="color:#ff3333; font-size:24px; margin-right:15px;">✘</span>`;
        
        row.innerHTML = `<div style="display:flex; align-items:center;">
                           <span style="opacity:0.5; width:30px; font-size:20px;">#${i+1}</span>
                           <img src="${av}" onerror="handleAvatarError(this)">
                           <span style="font-size: 28px; font-weight:bold;">${name}</span>
                         </div>
                         <div style="display:flex; align-items:center;">
                           ${icon}
                           <span style="font-weight:900; font-size:32px;">${scoreOf(p)}</span>
                         </div>`;
        lb.appendChild(row);
      });
    }
  });

  connection.on("game_over", () => {
    showOnly('gameOverView');
    stopYoutube();
    manageBackgroundMusic(true);

    const podium = $('podium');
    if (podium) {
      podium.innerHTML = '';
      const winners = [...globalPlayers].sort((a,b) => scoreOf(b)-scoreOf(a)).slice(0,3);
      const order = [winners[1], winners[0], winners[2]].filter(Boolean);
      
      order.forEach(p => {
         const rank = winners.indexOf(p) + 1;
         const av = fixAssetPath(p.avatar);
         const col = document.createElement('div');
         col.className = `podium-column rank-${rank}`;
         
         col.innerHTML = `
            <div style="font-weight:bold; font-size:24px; margin-bottom:5px;">${p.name||p.Name}</div>
            <img src="${av}" onerror="handleAvatarError(this)" class="podium-avatar">
            <div class="podium-block">
                <div>${rank}</div>
            </div>
            <div style="font-size:20px; font-weight:bold; margin-top:10px;">${scoreOf(p)} pts</div>
         `;
         pod.appendChild(col);
      });
    }
  });

  connection.on("lobby_deleted", () => {
    isMusicRound = false; isGameInMusicMode = false;
    stopYoutube(); bgMusic.pause(); showOnly('setup');
  });

  showSetup();
  </script>
</body>
</html>